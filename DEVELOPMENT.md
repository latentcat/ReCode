# ReCode å¼€å‘æ–‡æ¡£

> æœ¬æ–‡æ¡£é¢å‘æ–°æ‰‹å¼€å‘è€…ï¼Œç”¨ç®€å•æ¸…æ™°çš„è¯­è¨€ä»‹ç» ReCode é¡¹ç›®çš„ä»£ç ç»“æ„å’Œå·¥ä½œåŸç†ã€‚

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒæ€æƒ³](#2-æ ¸å¿ƒæ€æƒ³)
3. [ç›®å½•ç»“æ„](#3-ç›®å½•ç»“æ„)
4. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#4-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
5. [æ‰§è¡Œæµç¨‹å›¾è§£](#5-æ‰§è¡Œæµç¨‹å›¾è§£)
6. [å…³é”®æ¦‚å¿µè§£é‡Š](#6-å…³é”®æ¦‚å¿µè§£é‡Š)
7. [å¦‚ä½•æ‰©å±•](#7-å¦‚ä½•æ‰©å±•)

---

## 1. é¡¹ç›®æ¦‚è¿°

ReCode æ˜¯ä¸€ä¸ª **LLM Agent æ¡†æ¶**ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ **é€’å½’ä»£ç ç”Ÿæˆ** æ¥ç»Ÿä¸€"è§„åˆ’"å’Œ"æ‰§è¡Œ"ã€‚

### ä¸€å¥è¯è§£é‡Š

> æŠŠå¤æ‚ä»»åŠ¡æ‹†æˆä»£ç æ ‘ï¼Œé‡åˆ°"ä¸ä¼šåšçš„å‡½æ•°"å°±è®© LLM å±•å¼€ï¼Œç›´åˆ°å…¨éƒ¨å˜æˆèƒ½ç›´æ¥æ‰§è¡Œçš„åŠ¨ä½œã€‚

### é€‚ç”¨åœºæ™¯

- éœ€è¦å¤šæ­¥éª¤æ¨ç†çš„ä»»åŠ¡ï¼ˆå¦‚ï¼šæœºå™¨äººå¯¼èˆªã€ç½‘é¡µæ“ä½œï¼‰
- ä»»åŠ¡ç²’åº¦ä¸å›ºå®šï¼Œéœ€è¦åŠ¨æ€è°ƒæ•´
- éœ€è¦ç”Ÿæˆå¯è¿½æº¯çš„å†³ç­–è¿‡ç¨‹

---

## 2. æ ¸å¿ƒæ€æƒ³

### 2.1 ä¼ ç»Ÿæ–¹æ³• vs ReCode

| ä¼ ç»Ÿæ–¹æ³• (ReAct) | ReCode |
|-----------------|--------|
| æ€è€ƒ â†’ æ‰§è¡Œ â†’ è§‚å¯Ÿ â†’ æ€è€ƒ... | å†™ä»£ç  â†’ æ‰§è¡Œ â†’ é‡åˆ°å ä½å‡½æ•° â†’ å±•å¼€ â†’ ç»§ç»­æ‰§è¡Œ |
| æ¯æ­¥éƒ½è¦ LLM å†³ç­– | åªåœ¨éœ€è¦æ—¶è°ƒç”¨ LLM |
| æ‰å¹³çš„åŠ¨ä½œåºåˆ— | æ ‘å½¢çš„ä»£ç ç»“æ„ |

### 2.2 æ ¸å¿ƒå¾ªç¯

```
ä»»åŠ¡å¼€å§‹
    â†“
åˆ›å»ºæ ¹èŠ‚ç‚¹: solve(ä»»åŠ¡)
    â†“
æ‰§è¡Œä»£ç  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                      â”‚
æˆåŠŸï¼Ÿâ”€â”€â”€ æ˜¯ â†’ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ â”€â”˜
    â”‚
    å¦
    â†“
æ˜¯å ä½å‡½æ•°ï¼Ÿâ”€â”€â”€ æ˜¯ â†’ è°ƒç”¨LLMå±•å¼€ â†’ åˆ›å»ºå­èŠ‚ç‚¹
    â”‚
    å¦
    â†“
æŠ¥é”™ï¼Œç»“æŸ
```

---

## 3. ç›®å½•ç»“æ„

```
ReCode/
â”œâ”€â”€ run.py                    # ğŸš€ ç¨‹åºå…¥å£ï¼Œå‘½ä»¤è¡Œå·¥å…·
â”œâ”€â”€ base/                     # ğŸ“¦ åŸºç¡€æŠ½è±¡ç±»
â”‚   â”œâ”€â”€ agent.py              #    Agent æ¥å£å®šä¹‰
â”‚   â””â”€â”€ environment.py        #    Environment æ¥å£å®šä¹‰
â”œâ”€â”€ agents/                   # ğŸ¤– Agent å®ç°
â”‚   â””â”€â”€ recode/
â”‚       â”œâ”€â”€ agent.py          #    ReCode Agent æ ¸å¿ƒé€»è¾‘
â”‚       â”œâ”€â”€ utils.py          #    è¾…åŠ©å·¥å…·ï¼ˆCodeNodeã€ä»£ç è§£æï¼‰
â”‚       â””â”€â”€ resources/        #    æç¤ºè¯å’Œç¤ºä¾‹
â”‚           â”œâ”€â”€ prompts/      #      LLM æç¤ºè¯æ¨¡æ¿
â”‚           â””â”€â”€ fewshots/     #      å°‘æ ·æœ¬ç¤ºä¾‹
â”œâ”€â”€ envs/                     # ğŸŒ ç¯å¢ƒå®ç°
â”‚   â”œâ”€â”€ alfworld/             #    ALFWorld å®¶å±…ä»»åŠ¡ç¯å¢ƒ
â”‚   â”œâ”€â”€ webshop/              #    WebShop è´­ç‰©ç¯å¢ƒ
â”‚   â””â”€â”€ sciworld/             #    ScienceWorld ç§‘å­¦å®éªŒç¯å¢ƒ
â”œâ”€â”€ utils/                    # ğŸ”§ å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ llm.py                #    LLM è°ƒç”¨å°è£…
â”‚   â”œâ”€â”€ executor.py           #    Python ä»£ç æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ common.py             #    é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ logger.py             #    æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ errors.py             #    è‡ªå®šä¹‰å¼‚å¸¸
â””â”€â”€ configs/                  # âš™ï¸ é…ç½®æ–‡ä»¶
    â”œâ”€â”€ profiles.yaml         #    LLM é…ç½®ï¼ˆAPI Key ç­‰ï¼‰
    â””â”€â”€ prices.json           #    æ¨¡å‹ä»·æ ¼è¡¨
```

---

## 4. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 4.1 åŸºç¡€ç±» (`base/`)

#### `base/agent.py` - Agent æ¥å£

```python
class Agent(ABC):
    async def act(observations) -> actions    # æ ¹æ®è§‚å¯Ÿè¿”å›åŠ¨ä½œ
    def reset(config, init_info)              # é‡ç½® Agent çŠ¶æ€
    def report() -> dict                      # è¿”å›è¿è¡ŒæŠ¥å‘Š
```

**ä½œç”¨**ï¼šå®šä¹‰æ‰€æœ‰ Agent å¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œç¡®ä¿ä¸åŒ Agent å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚

#### `base/environment.py` - ç¯å¢ƒæ¥å£

```python
class Env(ABC):
    async def run(actions) -> observations    # æ‰§è¡ŒåŠ¨ä½œï¼Œè¿”å›è§‚å¯Ÿ
    def reset(config) -> init_info            # é‡ç½®ç¯å¢ƒ
    def is_done() -> bool                     # æ˜¯å¦ç»“æŸ
    def is_success() -> bool                  # æ˜¯å¦æˆåŠŸ
    def report() -> dict                      # è¿”å›ç¯å¢ƒæŠ¥å‘Š
```

**ä½œç”¨**ï¼šå®šä¹‰ç¯å¢ƒçš„æ ‡å‡†æ¥å£ï¼Œè®© Agent å¯ä»¥å’Œä»»ä½•ç¯å¢ƒäº¤äº’ã€‚

---

### 4.2 ReCode Agent (`agents/recode/`)

#### `agent.py` - æ ¸å¿ƒé€»è¾‘

è¿™æ˜¯ ReCode çš„å¤§è„‘ï¼Œè´Ÿè´£ï¼š

1. **åˆå§‹åŒ–ä»£ç æ ‘**ï¼šæŠŠä»»åŠ¡å˜æˆæ ¹èŠ‚ç‚¹ `solve(instruction, observation)`
2. **æ‰§è¡Œå¾ªç¯**ï¼šæ‰§è¡ŒèŠ‚ç‚¹ä»£ç ï¼Œå¤„ç†ç»“æœ
3. **å±•å¼€å ä½å‡½æ•°**ï¼šè°ƒç”¨ LLM ç”Ÿæˆå­ä»£ç 
4. **ç®¡ç†çŠ¶æ€**ï¼šè·Ÿè¸ªå½“å‰èŠ‚ç‚¹ã€æ·±åº¦ç­‰

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³• | ä½œç”¨ |
|-----|------|
| `act()` | ä¸»å¾ªç¯ï¼šæ‰§è¡Œå½“å‰èŠ‚ç‚¹ï¼Œå¤„ç†ç»“æœ |
| `_handle_stub()` | å¤„ç†éœ€è¦å±•å¼€çš„å ä½å‡½æ•° |
| `_expand()` | è°ƒç”¨ LLM ç”Ÿæˆå±•å¼€ä»£ç  |
| `_execute()` | æ‰§è¡Œä»£ç ç‰‡æ®µ |
| `_init_code_tree()` | åˆå§‹åŒ–ä»£ç æ ‘ |
| `_build_expand_prompt()` | æ„å»º LLM æç¤ºè¯ |

#### `utils.py` - è¾…åŠ©å·¥å…·

**CodeNode ç±»**ï¼šä»£ç æ ‘çš„èŠ‚ç‚¹

```python
@dataclass
class CodeNode:
    code: str                    # è¿™ä¸ªèŠ‚ç‚¹çš„ä»£ç 
    parent: CodeNode             # çˆ¶èŠ‚ç‚¹
    children: list[CodeNode]     # å­èŠ‚ç‚¹åˆ—è¡¨
    status: NodeStatus           # çŠ¶æ€ï¼ˆç­‰å¾…/å®Œæˆ/éœ€å±•å¼€/å‡ºé”™ï¼‰
    depth: int                   # æ ‘çš„æ·±åº¦
    thought: str                 # LLM çš„æ€è€ƒè¿‡ç¨‹
    observations: list           # æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è§‚å¯Ÿ
```

**è¾…åŠ©å‡½æ•°**ï¼š

| å‡½æ•° | ä½œç”¨ |
|-----|------|
| `split_blocks()` | æŠŠä»£ç å­—ç¬¦ä¸²æ‹†åˆ†æˆç‹¬ç«‹çš„è¯­å¥ |
| `validate_blocks()` | éªŒè¯ä»£ç å—æ˜¯å¦åˆæ³• |
| `get_variables()` | ä»ä»£ç ä¸­æå–å˜é‡ä¿¡æ¯ |
| `parse_raw_observation()` | è§£æç¯å¢ƒçš„åˆå§‹è§‚å¯Ÿ |

---

### 4.3 å·¥å…·æ¨¡å— (`utils/`)

#### `executor.py` - ä»£ç æ‰§è¡Œå™¨

**æ ¸å¿ƒèŒè´£**ï¼š

1. **æ‰§è¡Œ Python ä»£ç **ï¼šç”¨ `exec()` è¿è¡Œä»£ç 
2. **ç®¡ç†å˜é‡**ï¼šä¿å­˜æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å˜é‡
3. **è°ƒç”¨ç¯å¢ƒ**ï¼šé€šè¿‡ `run("åŠ¨ä½œ")` ä¸ç¯å¢ƒäº¤äº’
4. **è¯†åˆ«å ä½å‡½æ•°**ï¼šæ•è· `NameError` åˆ¤æ–­æ˜¯å¦éœ€è¦å±•å¼€

**ç¥å¥‡çš„æœºåˆ¶**ï¼š

```python
# å½“æ‰§è¡Œè¿™è¡Œä»£ç æ—¶
obj_ID = find_and_take(obj, locations)

# Python ä¼šæŠ¥é”™ï¼šNameError: name 'find_and_take' is not defined

# Executor æ•è·è¿™ä¸ªé”™è¯¯ï¼Œåˆ¤æ–­å®ƒæ˜¯å ä½å‡½æ•°è°ƒç”¨
# è¿”å› "NeedExpansion" ä¿¡å·ï¼Œè€Œä¸æ˜¯å½“ä½œçœŸæ­£çš„é”™è¯¯
```

#### `llm.py` - LLM è°ƒç”¨å°è£…

**AsyncLLM ç±»**ï¼šå¼‚æ­¥è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹

```python
llm = AsyncLLM("default")                    # åˆ›å»ºå®ä¾‹
response, cost = await llm(prompt)           # è°ƒç”¨
```

**åŠŸèƒ½**ï¼š
- æ”¯æŒå¤šä¸ªé…ç½® profileï¼ˆä¸åŒçš„ API Keyã€æ¨¡å‹ï¼‰
- è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚
- è®¡ç®— API è°ƒç”¨è´¹ç”¨

#### `common.py` - é€šç”¨å·¥å…·

| å‡½æ•° | ä½œç”¨ |
|-----|------|
| `read_json_file()` | è¯»å– JSON æ–‡ä»¶ |
| `write_json_file()` | å†™å…¥ JSON æ–‡ä»¶ |
| `read_yaml_file()` | è¯»å– YAML æ–‡ä»¶ |
| `parse_code_block()` | ä» Markdown ä¸­æå–ä»£ç å— |
| `parse_xml_tag()` | ä»æ–‡æœ¬ä¸­æå– XML æ ‡ç­¾å†…å®¹ |

#### `logger.py` - æ—¥å¿—å·¥å…·

**SimpleLogger ç±»**ï¼šå°è£…æ—¥å¿—è®°å½•åŠŸèƒ½

```python
logger = SimpleLogger(run_id="my_experiment")
logger.info("å¼€å§‹è¿è¡Œ...")
logger.log_stats({"total_tests": 10, "successful_tests": 8})
```

**åŠŸèƒ½**ï¼š
- åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°
- è‡ªåŠ¨åˆ›å»ºæ—¥å¿—ç›®å½• `logs/<run_id>/running_logs/`
- æ”¯æŒå¤šè¡Œæ—¥å¿—æ ¼å¼åŒ–

#### `mockllm.py` - æ¨¡æ‹Ÿ LLM

ç”¨äºæµ‹è¯•å’Œè°ƒè¯•çš„æ¨¡æ‹Ÿ LLMï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è¾“å…¥å“åº”ã€‚

```python
mock_llm = MockLLM()
response = await mock_llm("ä½ å¥½")  # åœ¨æ§åˆ¶å°æ‰‹åŠ¨è¾“å…¥å“åº”
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- è°ƒè¯• Agent é€»è¾‘æ—¶ä¸æƒ³èŠ±è´¹ API è´¹ç”¨
- æ‰‹åŠ¨æ§åˆ¶ Agent çš„å†³ç­–è¿‡ç¨‹

#### `errors.py` - è‡ªå®šä¹‰å¼‚å¸¸

| å¼‚å¸¸ç±» | è¯´æ˜ |
|-------|------|
| `StepLimitError` | ç¯å¢ƒæ‰§è¡Œæ­¥æ•°è¶…è¿‡æœ€å¤§é™åˆ¶æ—¶æŠ›å‡º |

---

### 4.4 ç¯å¢ƒæ¨¡å— (`envs/`)

æ¯ä¸ªç¯å¢ƒæ–‡ä»¶å¤¹åŒ…å«ï¼š
- `env.py`ï¼šç¯å¢ƒå®ç°ç±»
- `base_config.yaml`ï¼šç¯å¢ƒé…ç½®
- `data/`ï¼šæ•°æ®æ–‡ä»¶ï¼ˆå¦‚ä»»åŠ¡ç´¢å¼•ï¼‰

**æ”¯æŒçš„ç¯å¢ƒ**ï¼š

| ç¯å¢ƒ | è¯´æ˜ | ä»»åŠ¡ç±»å‹ |
|-----|------|---------|
| ALFWorld | å®¶å±…æœºå™¨äººä»»åŠ¡ | put, clean, heat, cool, examine, puttwo |
| WebShop | ç½‘é¡µè´­ç‰©ä»»åŠ¡ | æœç´¢ã€æµè§ˆã€è´­ä¹°å•†å“ |
| ScienceWorld | ç§‘å­¦å®éªŒä»»åŠ¡ | ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©å®éªŒ |

#### ALFWorld ç¯å¢ƒè¯¦è§£ (`envs/alfworld/`)

ALFWorld æ˜¯ä¸€ä¸ªåŸºäº TextWorld çš„å®¶å±…äº¤äº’ç¯å¢ƒã€‚

**å¯ç”¨åŠ¨ä½œ**ï¼ˆåœ¨ `resources/prompts/alfworld/actions.txt` ä¸­å®šä¹‰ï¼‰ï¼š
- `go to <location>` - å‰å¾€æŸä½ç½®ï¼ˆå¦‚ `go to table 1`ï¼‰
- `take <object> from <location>` - æ‹¿å–ç‰©å“
- `put <object> in/on <location>` - æ”¾ç½®ç‰©å“
- `open/close <object>` - æ‰“å¼€/å…³é—­å®¹å™¨
- `examine <object>` - æ£€æŸ¥ç‰©å“æˆ–ä½ç½®
- `use <object>` - ä½¿ç”¨ç‰©å“ï¼ˆåŠ çƒ­ã€å†·å´ç­‰ï¼‰

**ä»»åŠ¡ç±»å‹è¯´æ˜**ï¼š

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ä»»åŠ¡ |
|-----|------|---------|
| `put` | æ‰¾åˆ°ç‰©å“æ”¾åˆ°æŒ‡å®šä½ç½® | "æŠŠè‹¹æœæ”¾åˆ°æ¡Œå­ä¸Š" |
| `clean` | æ¸…æ´ç‰©å“åæ”¾ç½® | "æ¸…æ´—æ¯å­æ”¾åˆ°æŸœå­é‡Œ" |
| `heat` | åŠ çƒ­ç‰©å“åæ”¾ç½® | "ç”¨å¾®æ³¢ç‚‰åŠ çƒ­åœŸè±†æ”¾åˆ°ç›˜å­ä¸Š" |
| `cool` | å†·å´ç‰©å“åæ”¾ç½® | "ç”¨å†°ç®±å†·å´ç•ªèŒ„æ”¾åˆ°å°é¢ä¸Š" |
| `examine` | åœ¨ç¯å…‰ä¸‹æ£€æŸ¥ç‰©å“ | "åœ¨å°ç¯ä¸‹æ£€æŸ¥ä¹¦" |
| `puttwo` | æ”¾ç½®ä¸¤ä¸ªåŒç±»ç‰©å“ | "æŠŠä¸¤ä¸ªè‹¹æœæ”¾åˆ°å†°ç®±é‡Œ" |

---

### 4.5 é…ç½®æ¨¡å— (`configs/`)

#### `profiles.yaml` - LLM é…ç½®

é…ç½®ä¸åŒçš„ LLM è®¿é—®å‚æ•°ï¼Œæ”¯æŒå¤šä¸ª profileã€‚

```yaml
models:
  default:
    api_key: "sk-your_api_key"
    base_url: "https://api.openai.com/v1"
    model: "gpt-4o-mini"
    temperature: 0.0
  
  gpt-4o:
    api_key: "sk-your_api_key"
    model: "gpt-4o"
    temperature: 0.7
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp configs/profiles_example.yaml configs/profiles.yaml

# ç¼–è¾‘å¡«å…¥ä½ çš„ API Key
# ç„¶åè¿è¡Œæ—¶æŒ‡å®š profile
python run.py --profile gpt-4o
```

#### `prices.json` - æ¨¡å‹ä»·æ ¼è¡¨

ç”¨äºè®¡ç®— API è°ƒç”¨è´¹ç”¨ï¼Œå•ä½æ˜¯ç¾å…ƒ/ç™¾ä¸‡ tokenã€‚

```json
{
    "gpt-4o": {"input": 2.5, "output": 10.0},
    "gpt-4o-mini": {"input": 0.15, "output": 0.6}
}
```

---

### 4.5 ä¸»ç¨‹åº (`run.py`)

**åŠŸèƒ½**ï¼š
1. è§£æå‘½ä»¤è¡Œå‚æ•°
2. åŠ è½½é…ç½®æ–‡ä»¶
3. åˆ›å»º Agent å’Œ Environment å®ä¾‹
4. è¿è¡Œå¤šä¸ªä»»åŠ¡å®ä¾‹ï¼ˆæ”¯æŒå¹¶å‘ï¼‰
5. æ”¶é›†ç»“æœå¹¶ç”ŸæˆæŠ¥å‘Š

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# å•ä¸ªå®ä¾‹
python run.py -a recode -e alfworld -n 1

# å¤šå®ä¾‹å¹¶å‘
python run.py -a recode -e webshop -n 10 -c 5

# ä½¿ç”¨é…ç½®æ–‡ä»¶
python run.py -C configs/example.yaml
```

---

## 5. æ‰§è¡Œæµç¨‹å›¾è§£

### 5.1 æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           run.py                                 â”‚
â”‚  1. è§£æå‘½ä»¤è¡Œå‚æ•°                                                â”‚
â”‚  2. åˆ›å»º Agent å’Œ Env å®ä¾‹                                       â”‚
â”‚  3. è°ƒç”¨ run_single_instance()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    run_single_instance()                         â”‚
â”‚  while not env.is_done():                                        â”‚
â”‚      actions = await agent.act(observations)                     â”‚
â”‚      observations = await env.run(actions)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      agent.act()                                 â”‚
â”‚  1. å¦‚æœå½“å‰èŠ‚ç‚¹éœ€è¦å±•å¼€ â†’ è°ƒç”¨ LLM                               â”‚
â”‚  2. æ‰§è¡Œå½“å‰èŠ‚ç‚¹ä»£ç                                               â”‚
â”‚  3. æ ¹æ®æ‰§è¡Œç»“æœæ›´æ–°çŠ¶æ€                                          â”‚
â”‚  4. ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä»£ç æ ‘æ¼”å˜è¿‡ç¨‹

ä»¥ "æŠŠè‹¹æœæ”¾åˆ°æ¡Œå­ä¸Š" ä»»åŠ¡ä¸ºä¾‹ï¼š

**åˆå§‹çŠ¶æ€**ï¼š
```
solve("æŠŠè‹¹æœæ”¾åˆ°æ¡Œå­ä¸Š", observation)  [PENDING]
```

**ç¬¬ 1 æ¬¡å±•å¼€å**ï¼š
```
solve(...)  [STUB â†’ å·²å±•å¼€]
â”œâ”€â”€ apple_id = find_and_take("apple", locations)  [PENDING]
â””â”€â”€ put_on(apple_id, "table")  [PENDING]
```

**ç¬¬ 2 æ¬¡å±•å¼€å**ï¼š
```
solve(...)  [COMPLETED]
â”œâ”€â”€ find_and_take(...)  [STUB â†’ å·²å±•å¼€]
â”‚   â”œâ”€â”€ for loc in locations:  [PENDING]
â”‚   â”‚       run("go to ...")
â”‚   â”‚       run("take ...")
â””â”€â”€ put_on(...)  [PENDING]
```

**æ‰§è¡Œå®Œæˆå**ï¼š
```
solve(...)  [COMPLETED]
â”œâ”€â”€ find_and_take(...)  [COMPLETED]
â”‚   â””â”€â”€ (for å¾ªç¯å·²æ‰§è¡Œ)  [COMPLETED]
â””â”€â”€ put_on(...)  [COMPLETED]
```

---

## 6. å…³é”®æ¦‚å¿µè§£é‡Š

### 6.1 èŠ‚ç‚¹çŠ¶æ€ (NodeStatus)

| çŠ¶æ€ | å«ä¹‰ | ä¸‹ä¸€æ­¥ |
|-----|------|-------|
| `PENDING` | ç­‰å¾…æ‰§è¡Œ | æ‰§è¡Œä»£ç  |
| `COMPLETED` | æ‰§è¡ŒæˆåŠŸ | ç§»åŠ¨åˆ°ä¸‹ä¸€èŠ‚ç‚¹ |
| `STUB` | å ä½å‡½æ•°ï¼Œéœ€è¦å±•å¼€ | è°ƒç”¨ LLM |
| `ERROR` | æ‰§è¡Œå‡ºé”™ | ç»ˆæ­¢æˆ–é‡è¯• |
| `SKIP` | è·³è¿‡ | ç§»åŠ¨åˆ°ä¸‹ä¸€èŠ‚ç‚¹ |

### 6.2 å ä½å‡½æ•°æ£€æµ‹æœºåˆ¶

```python
# executor.py ä¸­çš„å…³é”®ä»£ç 

try:
    exec(code, variables)  # æ‰§è¡Œä»£ç 
except NameError as e:
    # æ£€æŸ¥æ˜¯ä¸æ˜¯å‡½æ•°è°ƒç”¨
    if "å‡½æ•°å(" in code:
        return "NeedExpansion"  # æ ‡è®°ä¸ºéœ€è¦å±•å¼€
    else:
        return "Error"  # çœŸæ­£çš„é”™è¯¯
```

### 6.3 next() æ–¹æ³•ï¼šæ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

```python
def next(self):
    # 1. å…ˆçœ‹å­èŠ‚ç‚¹
    for child in self.children:
        if child.status == PENDING:
            return child
    
    # 2. å†çœ‹å…„å¼ŸèŠ‚ç‚¹
    for sibling in å³è¾¹çš„å…„å¼Ÿ:
        if sibling.status == PENDING:
            return sibling
    
    # 3. å‘ä¸Šå›æº¯
    return self.parent.next()
```

---

## 7. å¦‚ä½•æ‰©å±•

### 7.1 æ·»åŠ æ–°ç¯å¢ƒ

1. åˆ›å»º `envs/your_env/env.py`ï¼š

```python
from base.environment import Env

class YourEnv(Env):
    async def _run(self, action: str):
        # å®ç°åŠ¨ä½œæ‰§è¡Œé€»è¾‘
        return observation
    
    def reset(self, config, id=None):
        # åˆå§‹åŒ–ç¯å¢ƒ
        return {"observations": [...], "env_name": "your_env", "env": self}
    
    def is_success(self):
        return self._success
    
    def report(self):
        return {"success": self._success, ...}
```

2. åœ¨ `run.py` ä¸­æ³¨å†Œåˆ«åï¼š

```python
ENV_ALIASES = {
    "your_env": "envs.your_env.env.YourEnv",
}
```

3. åˆ›å»ºæç¤ºè¯å’Œç¤ºä¾‹ï¼š
   - `agents/recode/resources/prompts/your_env/actions.txt`
   - `agents/recode/resources/fewshots/your_env/base.txt`

### 7.2 ä¿®æ”¹ Agent è¡Œä¸º

å¯ä»¥ä¿®æ”¹è¿™äº›éƒ¨åˆ†ï¼š

| æ–‡ä»¶ | å¯ä¿®æ”¹å†…å®¹ |
|-----|-----------|
| `agents/recode/agent.py` | å±•å¼€é€»è¾‘ã€æ·±åº¦é™åˆ¶ã€é‡è¯•ç­–ç•¥ |
| `resources/prompts/default_new.py` | LLM æç¤ºè¯æ¨¡æ¿ |
| `resources/fewshots/` | å°‘æ ·æœ¬ç¤ºä¾‹ |

---

## é™„å½•ï¼šå¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹å¸®åŠ©
python run.py --help

# ALFWorld æµ‹è¯•
python run.py -a recode -e alfworld -n 5 --profile default

# WebShop æµ‹è¯•
python run.py -a recode -e webshop -n 10 -c 3

# ä½¿ç”¨æŒ‡å®šé…ç½®
python run.py -C configs/example.yaml

# æŸ¥çœ‹æ—¥å¿—
ls logs/
```

---

*æ–‡æ¡£æ›´æ–°æ—¥æœŸï¼š2025-01*

